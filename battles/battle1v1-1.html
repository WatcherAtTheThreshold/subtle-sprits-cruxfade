<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subtle Spirits: Cruxfade - Battle 1</title>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Barlow+Semi+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Stylesheets - FIXED ORDER -->
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/battle-shared.css">
  <link rel="stylesheet" href="../css/battle-1v1.css">
</head>

<body>
  <!-- Atmospheric mist background -->
  <div class="mist-overlay"></div>
  
  <!-- Battle title and status -->
  <h1 id="battle-status">Level 1 - Battle 1</h1>
  
  <!-- Special move information display -->
  <div id="special-info" class="hidden">&nbsp;</div>
  
  <!-- Main battle arena -->
  <main class="board battle-1v1" id="battle-board">
    
    <!-- Player team area (hero) -->
    <section id="player-team" class="team-area" role="region" aria-label="Your Character">
      <!-- Player character card will be inserted here by JavaScript -->
    </section>
    
    <!-- Enemy team area (villain) -->
    <section id="enemy-team" class="team-area" role="region" aria-label="Enemy Character">
      <!-- Enemy character card will be inserted here by JavaScript -->
    </section>
    
  </main>
  
  <!-- Battle controls -->
  <div class="button-controls">
    <button id="battle-button" class="action-button" onclick="handleBattleClick()">
      Start Battle
    </button>
    
    <!-- Restart container for post-battle options -->
    <div id="restart-container"></div>
  </div>

  <!-- Scripts - FIXED LOADING ORDER -->
  <script src="../js/battle-shared.js"></script>
  <script src="../js/battle-1v1.js"></script>
  
  <!-- Simplified and Fixed Initialization Script -->
  <script>
// ═══════════════════════════════════════════════════════════════════════════════
// SIMPLIFIED BATTLE INITIALIZATION - FIXED VERSION
// ═══════════════════════════════════════════════════════════════════════════════

// Global state
let battleInitialized = false;
let initRetries = 0;
const maxRetries = 10;

// Debug logging
function log(message, type = 'info') {
  const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
  console.log(`[${timestamp}] [BATTLE-1V1] ${message}`);
}

// Check if required systems are loaded
function checkSystemsReady() {
  const battleSharedReady = window.BattleShared && window.BattleShared.RosterUtils;
  const battle1v1Ready = window.Battle1v1 && typeof window.Battle1v1.init === 'function';
  const battleStateReady = window.battleState && typeof window.battleState.getPlayerCharacterData === 'function';
  
  return {
    allReady: battleSharedReady && battle1v1Ready && battleStateReady,
    battleShared: battleSharedReady,
    battle1v1: battle1v1Ready,
    battleState: battleStateReady
  };
}

// Initialize battle system
function initializeBattle() {
  if (battleInitialized) {
    log('Battle already initialized');
    return true;
  }
  
  const systems = checkSystemsReady();
  log(`Systems check: ${JSON.stringify(systems)}`);
  
  if (systems.allReady) {
    try {
      log('Initializing Battle1v1 system...');
      const success = window.Battle1v1.init();
      
      if (success) {
        battleInitialized = true;
        log('✓ Battle system initialized successfully!');
        setupUI();
        return true;
      } else {
        throw new Error('Battle1v1.init() returned false');
      }
    } catch (error) {
      log(`✗ Initialization failed: ${error.message}`);
      showError('Failed to initialize battle: ' + error.message);
      return false;
    }
  } else {
    // Retry logic
    initRetries++;
    if (initRetries < maxRetries) {
      log(`Systems not ready, retry ${initRetries}/${maxRetries} in 200ms...`);
      setTimeout(initializeBattle, 200);
    } else {
      const missing = Object.keys(systems).filter(key => key !== 'allReady' && !systems[key]);
      showError(`Failed to load required systems: ${missing.join(', ')}`);
    }
    return false;
  }
}

// Set up UI after successful initialization
function setupUI() {
  try {
    // Update battle title with character name
    const selectedChar = getSelectedCharacter();
    if (selectedChar) {
      updateBattleTitle(selectedChar.name);
    }
    
    // Ensure cards are visible
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
      card.style.opacity = '1';
      card.style.visibility = 'visible';
    });
    
    log(`✓ UI setup complete. ${cards.length} cards found.`);
  } catch (error) {
    log(`UI setup error: ${error.message}`);
  }
}

// Get selected character
function getSelectedCharacter() {
  try {
    if (window.battleState) {
      const data = window.battleState.getPlayerCharacterData();
      return data;
    }
  } catch (e) {
    log('Could not get selected character: ' + e.message);
  }
  return null;
}

// Update battle title
function updateBattleTitle(characterName) {
  const titleElement = document.getElementById('battle-status');
  if (titleElement && characterName) {
    const isMobile = window.innerWidth <= 768;
    titleElement.textContent = isMobile ? 
      `${characterName}'s Battle` : 
      `Level 1 - Battle 1: ${characterName}`;
  }
}

// Show error message
function showError(message) {
  const statusElement = document.getElementById('battle-status');
  if (statusElement) {
    statusElement.textContent = `Error: ${message}`;
    statusElement.style.color = '#ff6b6b';
  }
  
  const battleButton = document.getElementById('battle-button');
  if (battleButton) {
    battleButton.textContent = 'Retry';
    battleButton.onclick = () => {
      initRetries = 0;
      battleInitialized = false;
      statusElement.style.color = '';
      statusElement.textContent = 'Retrying...';
      setTimeout(initializeBattle, 100);
    };
  }
}

// Main battle button handler
function handleBattleClick() {
  if (!battleInitialized) {
    log('Battle not initialized, attempting initialization...');
    initializeBattle();
    return;
  }
  
  try {
    log('Starting battle...');
    window.Battle1v1.start();
  } catch (error) {
    log(`Battle start error: ${error.message}`);
    showError('Battle error: ' + error.message);
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeBattle);
} else {
  // DOM already loaded
  setTimeout(initializeBattle, 100);
}

// Additional fallback
window.addEventListener('load', () => {
  if (!battleInitialized) {
    log('Fallback initialization on window load');
    setTimeout(initializeBattle, 200);
  }
});

// Export for debugging
window.BattleDebug = {
  reinit: () => {
    initRetries = 0;
    battleInitialized = false;
    initializeBattle();
  },
  status: () => ({
    initialized: battleInitialized,
    retries: initRetries,
    systems: checkSystemsReady(),
    character: getSelectedCharacter()
  })
};

log('Battle initialization script loaded');
  </script>

  <!-- Minimal inline styles for essential UI -->
  <style>
    /* Team area labels */
    .team-area {
      position: relative;
    }
    
    .team-area::before {
      content: attr(aria-label);
      position: absolute;
      top: -2rem;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Bangers', cursive;
      font-size: clamp(0.8rem, 2vw, 1.2rem);
      color: rgba(255, 221, 68, 0.8);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: 1;
    }
    
    @media (max-width: 768px) {
      .team-area::before {
        font-size: clamp(0.7rem, 3vw, 1rem);
        top: -1.5rem;
      }
    }
    
    /* Error state styling */
    #battle-status[style*="color: rgb(255, 107, 107)"] {
      animation: errorPulse 1s ease-in-out infinite;
    }
    
    @keyframes errorPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</body>
</html>
